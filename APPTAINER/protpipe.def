Bootstrap: docker
From: condaforge/miniforge3

%environment
    export LC_ALL=en_US.utf-8
    export LANG=en_US.utf-8
    export LANGUAGE=en_US.UTF-8

%files
    requirements.yml

%post
    # Ensure locales packages installed
    apt-get -y update
    apt-get install -y locales locales-all
    apt-get -y install g++


    # Create target dir for non-root-accessible bashrc
    mkdir -p /opt/etc

    # Define environment name. Doesn't really matter as it's auto-loaded regardless
    ENVNAME='protpipe'

    # Create environment using mamba
    conda env create --prefix /opt/etc/${ENVNAME} -f requirements.yml
    
    # Finalize bashrc file and save to /.singularity.d/env/ for auto-loading
    echo "#! /usr/bin/env bash\n\n# script to activate the conda environment" > /root/.bashrc 
    conda init bash && . /root/.bashrc
    echo "echo \"Activating ${ENVNAME}\"" >>  /root/.bashrc
    echo "\nconda activate /opt/etc/${ENVNAME}" >> /root/.bashrc
    cp /root/.bashrc /.singularity.d/env/99-activate-conda.sh

    # Install R packages not on bioconda
    conda activate /opt/etc/${ENVNAME}
    R --slave -e "install.packages('SomaDataIO', repos='http://cran.us.r-project.org')"

%runscript
    exec /bin/bash "$@"